apiVersion: apps/v1
kind: Deployment
metadata:
  name: pong-centrifugo
  namespace: pong
  labels:
    app: pong-centrifugo
spec:
  replicas: 1
  strategy:
    type: Recreate
  selector:
    matchLabels:
      app: pong-centrifugo
  template:
    metadata:
      labels:
        app: pong-centrifugo
      annotations:
        # Vault Agent Injector annotations
        vault.hashicorp.com/agent-inject: "true"
        vault.hashicorp.com/role: "pong"
        vault.hashicorp.com/agent-inject-secret-config: "secret/data/pong/centrifugo"
        vault.hashicorp.com/agent-inject-template-config: |
          {{- with secret "secret/data/pong/centrifugo" -}}
          {
            "token_hmac_secret_key": "{{ .Data.data.token_hmac_secret_key }}",
            "api_key": "{{ .Data.data.api_key }}",
            "admin": true,
            "admin_password": "admin",
            "admin_secret": "admin-secret",
            "allowed_origins": ["*"],
            "engine": "redis",
            "redis_address": "{{ .Data.data.redis_address }}",
            "redis_prefix": "centrifugo",
            "proxy_rpc_endpoint": "http://pong-backend:8080/v1/centrifugo/rpc",
            "proxy_include_connection_meta": true,
            "proxy_http_headers": ["X-Centrifugo-User-Id"],
            "allow_anonymous_connect_without_token": true,
            "client_concurrency": 128,
            "client_channel_limit": 16,
            "client_queue_max_size": 1048576,
            "client_user_connection_limit": 4,
            "namespaces": [
              {
                "name": "pong_public",
                "history_size": 10,
                "history_ttl": "300s",
                "force_recovery": true,
                "presence": true,
                "join_leave": true,
                "force_push_join_leave": true,
                "allow_subscribe_for_anonymous": true,
                "allow_subscribe_for_client": true,
                "allow_history_for_anonymous": true,
                "allow_history_for_client": true,
                "allow_publish_for_anonymous": false,
                "allow_presence_for_anonymous": false
              },
              {
                "name": "pong_private",
                "history_size": 0,
                "history_ttl": "0s",
                "force_recovery": false,
                "presence": true,
                "join_leave": true,
                "force_push_join_leave": true,
                "allow_subscribe_for_anonymous": false,
                "allow_publish_for_anonymous": false
              }
            ]
          }
          {{- end -}}
    spec:
      serviceAccountName: default
      containers:
      - name: centrifugo
        image: centrifugo/centrifugo:v5
        command: ["/bin/sh", "-c"]
        args:
          - |
            echo "Waiting for Vault config file..."
            for i in $(seq 1 30); do
              if [ -f /vault/secrets/config ]; then
                echo "Config file found, starting Centrifugo..."
                exec centrifugo --config=/vault/secrets/config
              fi
              echo "Attempt $i: Config not found, waiting..."
              sleep 1
            done
            echo "ERROR: Config file not found after 30 seconds"
            exit 1
        ports:
        - containerPort: 8000
          name: http
        resources:
          limits:
            cpu: 500m
            memory: 256Mi
          requests:
            cpu: 100m
            memory: 128Mi
